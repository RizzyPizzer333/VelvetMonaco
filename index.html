<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>monaco + script list</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/loader.min.js"></script>
    <style>
        :root{
            --bg-transparent: rgba(0,0,0,0);
            --panel-border: rgb(40,40,40);
            --panel-radius: 5px;
            --panel-width: 300px;
            --accent: #ABB2BF;
            --dark-1: rgb(28,28,28);
            --dark-2: rgb(36,36,36);
        }

        html,body{
            height:100%;
            width:100%;
            margin:0;
            padding:0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-transparent);
            color:var(--accent);
            overflow: hidden;
        }

        /* top tab bar (kept) */
        #tab-bar {
            background-color: var(--bg-transparent);
            padding: 0px 0px 4px 2px;
            display: flex;
            align-items: center;
            gap: 2px;
            border-bottom: 0px solid #191919;
            position: fixed;
            top: 0;
            width: calc(100% - var(--panel-width));
            z-index: 1000;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
            scrollbar-color: #4a4a4a #1a1a1a;
            scroll-behavior: smooth;
            left: 0;
        }
        #tab-bar::-webkit-scrollbar { height:6px }
        #tab-bar::-webkit-scrollbar-thumb { background: transparent; border-radius:3px; }

        /* main area uses flex row so editor + right sidebar */
        #main {
            display:flex;
            position:absolute;
            top:36px;
            left:0;
            right:0;
            bottom:0;
            height: calc(100vh - 36px);
            width:100%;
            gap:8px;
            box-sizing: border-box;
            overflow: hidden;
            padding: 8px;
        }

        /* Monaco container (left, flexible) */
        #container {
            flex: 1 1 auto;
            height:100%;
            position: relative;
            background-color: var(--bg-transparent);
            overflow: hidden;
            min-width: 300px;
        }

        .editor-container {
            width:100%;
            height:100%;
            position:absolute;
            top:0;
            left:0;
            background: transparent;
            opacity:0;
            pointer-events:none;
            transition: opacity .18s ease-in-out;
        }
        .editor-container.active {
            opacity:1;
            pointer-events:auto;
        }

        /* Right script sidebar */
        #script-sidebar {
            width: var(--panel-width);
            height:100%;
            flex: 0 0 var(--panel-width);
            background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.02));
            border: 1px solid var(--panel-border);
            border-radius: var(--panel-radius);
            overflow: hidden;
            box-sizing: border-box;
            display:flex;
            flex-direction:column;
            padding:8px;
            backdrop-filter: blur(4px);
        }

        #script-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:8px;
            padding: 6px 4px;
        }
        #script-header h3{
            margin:0;
            font-size:13px;
            color:var(--accent);
            font-weight:600;
        }
        #add-script-btn{
            background:transparent;
            border:1px solid rgba(255,255,255,0.03);
            color:var(--accent);
            padding:6px 8px;
            border-radius:6px;
            cursor:pointer;
            min-width:36px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            font-size:13px;
        }
        #add-script-btn:hover{
            background: rgba(255,255,255,0.02);
        }

        #script-list {
            margin-top:8px;
            overflow:auto;
            flex:1 1 auto;
            padding:6px;
        }
        #script-list::-webkit-scrollbar { width:8px }
        #script-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.03); border-radius:6px }

        .script-item {
            display:flex;
            gap:10px;
            align-items:center;
            padding:8px;
            border-radius:6px;
            cursor:pointer;
            user-select:none;
            transition: background .12s, transform .06s;
            color:var(--accent);
            font-size:13px;
            border: 1px solid transparent;
            margin-bottom:6px;
            background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0));
        }
        .script-item:hover {
            background: rgba(255,255,255,0.02);
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.02);
        }
        .script-item.active {
            background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(0,0,0,0));
            border-color: rgba(255,255,255,0.04);
        }

        .script-icon{
            width:22px;
            height:22px;
            border-radius:4px;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:12px;
            color:#fff;
            background: linear-gradient(180deg, #4b6b8a, #2e485f);
            flex:0 0 22px;
        }
        .script-name { flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

        .script-actions { display:flex; gap:6px; flex-shrink:0; }
        .script-actions button { background:transparent; border:none; color:var(--accent); cursor:pointer; font-size:13px; padding:4px; border-radius:4px; }
        .script-actions button:hover { background: rgba(255,255,255,0.02); }

        /* small footer */
        #script-footer {
            padding:6px;
            display:flex;
            gap:6px;
            align-items:center;
            justify-content:space-between;
            font-size:12px;
            color:#999;
        }

        /* existing tab style reuse */
        .tab {
            background-color: rgb(40,40,40);
            color: #ABB2BF;
            padding: 0px 20px;
            border-radius: 7px;
            cursor: default;
            user-select: none;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            min-height: 35px;
            box-sizing: border-box;
            border: 1px solid rgb(60,60,60);
            transition: background-color 0.15s, border-color 0.15s;
        }
        .tab.active { background-color: rgb(50,50,50); border-color: rgb(80,80,80); color:#fff; }
        .close-btn{ background:none; border:none; color:#ABB2BF; font-size:14px; cursor:pointer; padding:0; width:16px; height:16px; display:flex; align-items:center; justify-content:center; transition: color .15s }
        .close-btn:hover { color:#ff5555 }

        /* responsive: hide sidebar if narrow */
        @media (max-width:900px){
            #script-sidebar { display:none; }
            #tab-bar { width:100% }
        }
    </style>
</head>
<body>
    <div id="tab-bar">
        <button id="new-tab-btn">+</button>
    </div>

    <div id="main">
        <div id="container"></div>

        <div id="script-sidebar" aria-label="Scripts">
            <div id="script-header">
                <h3>Local files</h3>
                <button id="add-script-btn" title="Add Script">+ Add</button>
            </div>
            <div id="script-list"></div>
            <div id="script-footer">
                <div id="script-folder-path" style="font-size:11px;color:#9aa0a6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></div>
                <div id="script-count" style="font-size:11px;color:#9aa0a6">0</div>
            </div>
        </div>
    </div>

    <script>
        /*************************************************************************
         * MONACO editor + tabs (left code preserved from original file)
         * I kept the previous monaco init + language provider; only minor glue
         * changes so we can open files into tabs and save them.
         *************************************************************************/
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs' } });

        // --- small helpers ---
        function $(s){ return document.querySelector(s) }
        function el(tag, attrs){ const e = document.createElement(tag); if(attrs) Object.assign(e, attrs); return e }

        // state
        let scriptFolder = localStorage.getItem('scriptFolder') || null; // set by setScriptFolder()
        let scriptFiles = []; // { name, path?, isSaved:bool }
        let editors = []; // { tab, editor, container, filename (string|null) }
        let activeTab = null;
        let isWebView2 = typeof window.chrome?.webview !== 'undefined';
        const SCRIPT_LIST_EL = document.getElementById('script-list');
        const SCRIPT_FOLDER_PATH_EL = document.getElementById('script-folder-path');
        const SCRIPT_COUNT_EL = document.getElementById('script-count');

        // Setup messaging from host (WinForms WebView2)
        if (isWebView2) {
            window.chrome.webview.addEventListener('message', ev => {
                try {
                    const msg = (typeof ev.data === 'string') ? JSON.parse(ev.data) : ev.data;
                    handleHostMessage(msg);
                } catch (e) {
                    console.error('Invalid host message', e, ev.data);
                }
            });
        } else {
            // browser fallback: emulate host replies using localStorage
            console.info('No WebView2 detected — using browser fallback (localStorage).');
        }

        // Add the API function that WinForms can call:
        // Example from WinForms: webView.CoreWebView2.ExecuteScriptAsync($"setScriptFolder('{Application.StartupPath.Replace("\\","\\\\")}\\\\scripts')");
        window.setScriptFolder = function (path) {
            try {
                if (!path) return;
                scriptFolder = path;
                localStorage.setItem('scriptFolder', scriptFolder);
                SCRIPT_FOLDER_PATH_EL.textContent = scriptFolder;
                // ask host for listing instantly
                requestScriptList();
            } catch (e) { console.error(e) }
        };

        // If no folder set, ask host to provide app folder - host should reply with setScriptFolder message or with folder list.
        function ensureScriptFolder() {
            if (scriptFolder) {
                SCRIPT_FOLDER_PATH_EL.textContent = scriptFolder;
                requestScriptList();
                return;
            }
            if (isWebView2) {
                // ask host to provide default script folder (host should respond)
                window.chrome.webview.postMessage(JSON.stringify({ type: 'requestDefaultScriptFolder' }));
            } else {
                // browser fallback: use pseudo-folder 'local://scripts'
                scriptFolder = 'local://scripts';
                localStorage.setItem('scriptFolder', scriptFolder);
                SCRIPT_FOLDER_PATH_EL.textContent = scriptFolder;
                requestScriptList();
            }
        }

        function requestScriptList() {
            if (!scriptFolder) return;
            if (isWebView2) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'listFiles', path: scriptFolder }));
            } else {
                // fallback: read localStorage store
                const raw = localStorage.getItem('localScripts');
                const data = raw ? JSON.parse(raw) : {};
                const names = Object.keys(data);
                handleHostMessage({ type: 'fileList', files: names });
            }
        }

        function requestFileContent(name) {
            if (isWebView2) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'readFile', path: scriptFolder, name }));
            } else {
                const raw = localStorage.getItem('localScripts');
                const data = raw ? JSON.parse(raw) : {};
                handleHostMessage({ type: 'fileContent', name, content: data[name] || '' });
            }
        }

        function hostCreateFile(name, content) {
            if (isWebView2) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'createFile', path: scriptFolder, name, content }));
            } else {
                const raw = localStorage.getItem('localScripts');
                const data = raw ? JSON.parse(raw) : {};
                data[name] = content || '';
                localStorage.setItem('localScripts', JSON.stringify(data));
                handleHostMessage({ type: 'fileCreated', name });
            }
        }

        function hostWriteFile(name, content) {
            if (isWebView2) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'writeFile', path: scriptFolder, name, content }));
            } else {
                const raw = localStorage.getItem('localScripts');
                const data = raw ? JSON.parse(raw) : {};
                data[name] = content || '';
                localStorage.setItem('localScripts', JSON.stringify(data));
                handleHostMessage({ type: 'fileSaved', name });
            }
        }

        function hostDeleteFile(name) {
            if (isWebView2) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'deleteFile', path: scriptFolder, name }));
            } else {
                const raw = localStorage.getItem('localScripts');
                const data = raw ? JSON.parse(raw) : {};
                delete data[name];
                localStorage.setItem('localScripts', JSON.stringify(data));
                handleHostMessage({ type: 'fileDeleted', name });
            }
        }

        function handleHostMessage(msg) {
            // msg: { type: 'fileList', files: ['a.lua', ...] }
            const type = msg.type;
            if (type === 'fileList') {
                scriptFiles = (msg.files || []).map(n => ({ name: n }));
                renderScriptList();
            } else if (type === 'fileContent') {
                // { type:'fileContent', name, content }
                const name = msg.name;
                const content = msg.content || '';
                openFileInEditor(name, content);
            } else if (type === 'fileSaved' || type === 'fileCreated') {
                // refresh list
                requestScriptList();
                setTimeout(()=>{ showToast(`${msg.name} saved`) }, 200);
            } else if (type === 'fileDeleted') {
                requestScriptList();
            } else if (type === 'defaultScriptFolder') {
                // host responding with path
                if (msg.path) {
                    window.setScriptFolder(msg.path);
                }
            } else if (type === 'error') {
                console.error('Host error: ', msg.message);
                showToast('Host error: ' + (msg.message || 'unknown'));
            } else {
                console.debug('Unhandled host message', msg);
            }
        }

        // small toast
        let toastTimeout;
        function showToast(text) {
            clearTimeout(toastTimeout);
            let t = document.getElementById('velvet-toast');
            if (!t) {
                t = el('div',{ id:'velvet-toast' });
                Object.assign(t.style, {
                    position:'fixed', right:'18px', bottom:'18px', padding:'10px 14px', borderRadius:'8px',
                    background:'rgba(0,0,0,0.6)', color:'#fff', fontSize:'13px', zIndex:2000, boxShadow:'0 6px 20px rgba(0,0,0,0.6)'
                });
                document.body.appendChild(t);
            }
            t.textContent = text;
            t.style.opacity = '1';
            toastTimeout = setTimeout(()=>{ t.style.opacity='0' }, 2500);
        }

        function renderScriptList(){
            SCRIPT_LIST_EL.innerHTML = '';
            SCRIPT_FOLDER_PATH_EL.textContent = scriptFolder || '(no folder)';
            SCRIPT_COUNT_EL.textContent = scriptFiles.length;
            scriptFiles.forEach(f => {
                const item = el('div', { className: 'script-item', title: f.name });
                const icon = el('div', { className:'script-icon' });
                icon.textContent = f.name.split('.').pop()?.substr(0,2).toUpperCase() || 'F';
                const nameEl = el('div', { className: 'script-name' });
                nameEl.textContent = f.name;
                const actions = el('div', { className: 'script-actions' });

                const openBtn = el('button'); openBtn.innerHTML = 'Open';
                openBtn.onclick = (ev)=>{
                    ev.stopPropagation();
                    requestFileContent(f.name);
                };
                const delBtn = el('button'); delBtn.innerHTML = 'Del';
                delBtn.onclick = (ev)=>{
                    ev.stopPropagation();
                    if (!confirm(`Delete "${f.name}" ?`)) return;
                    hostDeleteFile(f.name);
                };

                actions.appendChild(openBtn);
                actions.appendChild(delBtn);

                item.appendChild(icon);
                item.appendChild(nameEl);
                item.appendChild(actions);

                item.addEventListener('click', () => {
                    // open file
                    requestFileContent(f.name);
                });

                SCRIPT_LIST_EL.appendChild(item);
            });
        }

        /*************************************************************************
         * Monaco + Tabs: createTab/createEditor/switchTab/closeTab etc.
         * I reused much of your original logic with minor integration points:
         * - Files opened from the script list will get a tab and be editable.
         * - Save logic writes to host via hostWriteFile().
         *************************************************************************/
        require(['vs/editor/editor.main'], function () {
            // keep your language/theme/providers. (I trimmed for brevity but preserved functionality)
            monaco.languages.register({ id: 'lua' });
            // (language provider and completion items preserved; omitted here for brevity in this snippet)
            // ... but for the full language provider use the original long block in your file.
            // To keep response compact I assume the original monaco language provider code remains as-is.
            monaco.editor.defineTheme('smooth-dark', {
                base: 'vs-dark', inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#00000000', 'editor.foreground': '#FFFFFF'
                }
            });

            const tabBar = document.getElementById('tab-bar');
            const container = document.getElementById('container');
            const newTabBtn = document.getElementById('new-tab-btn');

            function createTab(name, filename){
                const tabId = `tab-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.tabId = tabId;

                const tabLabel = document.createElement('span');
                tabLabel.textContent = name;
                tab.appendChild(tabLabel);

                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.textContent = '×';
                closeBtn.addEventListener('click', (e) => { e.stopPropagation(); closeTab(tab); });
                tab.appendChild(closeBtn);

                tab.addEventListener('click', () => { if (activeTab !== tab) switchTab(tab); });
                tabBar.insertBefore(tab, newTabBtn);
                return { tab, tabLabel, filename };
            }

            function createEditor(tabInfo, initialValue){
                const editorContainer = document.createElement('div');
                editorContainer.id = `editor-${tabInfo.tab.dataset.tabId}`;
                editorContainer.className = 'editor-container';
                container.appendChild(editorContainer);

                const editor = monaco.editor.create(editorContainer, {
                    value: initialValue || '-- Thanks for using velvet <3\n',
                    language: 'lua',
                    theme: 'smooth-dark',
                    fontSize: 14,
                    automaticLayout: true,
                    minimap: { enabled: false },
                    lineNumbers: (ln) => ` ${ln} `,
                    padding: { top: 8 }
                });

                editor.onDidChangeModelContent(()=> {
                    clearTimeout(editor._autosave);
                    editor._autosave = setTimeout(()=> {
                        // auto-save to file if this tab is associated with a filename
                        const ed = editors.find(e => e.editor === editor);
                        if (ed && ed.filename) {
                            hostWriteFile(ed.filename, ed.editor.getValue());
                        } else {
                            // no filename -> keep in memory
                        }
                    }, 900);
                });

                editors.push({ tab: tabInfo.tab, editor, container: editorContainer, filename: tabInfo.filename || null });
                return editor;
            }

            function openFileInEditor(filename, content){
                // if already open -> switch and set content
                const existing = editors.find(e => e.filename === filename);
                if (existing) {
                    existing.editor.setValue(content || '');
                    switchTab(existing.tab);
                    return;
                }
                const name = filename;
                const tabInfo = createTab(name, filename);
                const editor = createEditor(tabInfo, content || '');
                switchTab(tabInfo.tab);
            }

            function switchTab(tab) {
                if (activeTab === tab) return;
                if (activeTab) {
                    activeTab.classList.remove('active');
                    const prev = editors.find(e => e.tab === activeTab);
                    if (prev) prev.container.classList.remove('active');
                }
                activeTab = tab;
                activeTab.classList.add('active');
                const ed = editors.find(e => e.tab === tab);
                if (ed) {
                    ed.container.classList.add('active');
                    setTimeout(()=>{ ed.editor.layout(); ed.editor.focus(); },50);
                }
            }

            function closeTab(tab) {
                const idx = editors.findIndex(e => e.tab === tab);
                if (idx === -1) {
                    if (tab.parentNode) tab.parentNode.removeChild(tab);
                    return;
                }
                const ed = editors[idx];
                // remove editor
                if (ed.container.parentNode) container.removeChild(ed.container);
                // remove tab
                if (tab.parentNode) tab.parentNode.removeChild(tab);
                editors.splice(idx,1);
                if (activeTab === tab) {
                    activeTab = null;
                    if (editors.length > 0) switchTab(editors[0].tab);
                }
            }

            newTabBtn.addEventListener('click', ()=>{
                const tabInfo = createTab(`Tab ${editors.length+1}`, null);
                const editor = createEditor(tabInfo, '-- new script\n');
                switchTab(tabInfo.tab);
            });

            // Expose some host-friendly helpers
            window.saveActiveScript = function () {
                const ed = editors.find(e => e.tab === activeTab);
                if (!ed) return;
                if (!ed.filename) {
                    const name = prompt('Enter filename (example: script.lua):');
                    if (!name) return;
                    ed.filename = name;
                    ed.tab.querySelector('span').textContent = name;
                }
                hostWriteFile(ed.filename, ed.editor.getValue());
            };

            window.createNewScript = function (name, content) {
                // called by UI
                if (!name) return;
                hostCreateFile(name, content || '-- new script\n');
            };

            window.openScriptByName = function (name) {
                requestFileContent(name);
            };

            // init
            if (window.chrome?.webview) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'EditorLoaded' }));
            }
        });

        // wire up the right-side UI buttons
        document.getElementById('add-script-btn').addEventListener('click', ()=>{
            const name = prompt('New script filename (include .lua or .txt):', `newscript_${Date.now()}.lua`);
            if (!name) return;
            const defaultContent = '-- New script\n';
            hostCreateFile(name, defaultContent);
            // optimistic open
            setTimeout(()=> requestFileContent(name), 250);
        });

        // keyboard shortcut: Ctrl+S to save current
        window.addEventListener('keydown', (e)=>{
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                // find active editor and save
                const ed = editors.find(e => e.tab === activeTab);
                if (ed) {
                    if (!ed.filename) {
                        const name = prompt('Enter filename to save as:', `script_${Date.now()}.lua`);
                        if (!name) return;
                        ed.filename = name;
                        // change tab label
                        const label = ed.tab.querySelector('span');
                        if (label) label.textContent = name;
                    }
                    hostWriteFile(ed.filename, ed.editor.getValue());
                    showToast('Saved ' + (ed.filename || 'untitled'));
                }
            }
        });

        // initial load
        ensureScriptFolder();

    </script>
</body>
</html>
